import React, { useState, useEffect, useRef } from 'react'; import { Plus, Trash2, Printer, Download, Activity, X, Archive, ChevronDown, ChevronRight, History, FileDown, Wand2, Loader2, Bold, Underline, Files, Save, Upload, AlertTriangle, CheckCircle, FileJson, User, UserPlus, LayoutDashboard, AlertCircle, Stethoscope, Lock } from 'lucide-react'; // --- CONFIGURATION --- const APP_PASSWORD = '343434'; // Default Data Structures const initialPatient = { id: '', room: '', name: '', age: '', gender: '', diagnosis: '', history: '', physicalExam: '', // New Field: GÃ¼ncel Fizik Muayene medications: [], logs: [], consults: [], antibiotics: [], narcotics: [], medReports: [], plan: '', status: 'stable' }; const initialDashboard = { bloodLabs: '', criticalObs: '', plans: '', cultures: '' }; // --- HELPER: Parse Simple HTML for PDFMake --- const parseHtmlToPdfMake = (htmlText) => { if (!htmlText) return { text: "" }; const parts = htmlText.split(/(<\/?(?:b|strong|u|span[^>]*|div|br\/?)>)/g); const content = []; let isBold = false; let isUnderline = false; parts.forEach(part => { if (part.match(/^<(b|strong)>/)) isBold = true; else if (part.match(/^<\/(b|strong)>/)) isBold = false; else if (part.match(/^<u>/)) isUnderline = true; else if (part.match(/^<\/u>/)) isUnderline = false; else if (part.match(/^<br\/?>/)) content.push({ text: '\n' }); else if (!part.match(/^<[^>]+>$/) && part !== '') { let text = part.replace(/&nbsp;/g, ' ').replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>'); content.push({ text: text, bold: isBold, decoration: isUnderline ? 'underline' : undefined }); } }); return content.length > 0 ? { text: content } : { text: htmlText }; }; // --- HELPER: AI Polish --- const polishNoteWithAI = async (text) => { const apiKey = ""; const stripHtml = (html) => { let tmp = document.createElement("DIV"); tmp.innerHTML = html; return tmp.textContent || tmp.innerText || ""; }; const cleanText = stripHtml(text); const prompt = Sen bir tÄ±bbi asistansÄ±n. Aceleyle yazÄ±lmÄ±ÅŸ bu TÃ¼rkÃ§e notu profesyonel, kÄ±sa ve net bir tÄ±bbi not haline getir. Sadece dÃ¼zeltilmiÅŸ metni ver.\n\nNot: "${cleanText}"; try { const response = await fetch( https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }), } ); const data = await response.json(); return data.candidates?.[0]?.content?.parts?.[0]?.text.trim() || cleanText; } catch (error) { console.error("AI Error", error); return cleanText; } }; // --- COMPONENT: Rich Text Editor --- const RichTextEditor = ({ value, onChange, placeholder, onPolish, isPolishing, minHeight = "100px" }) => { const editorRef = useRef(null); useEffect(() => { if (editorRef.current && editorRef.current.innerHTML !== value) { editorRef.current.innerHTML = value; } }, [value]); const handleInput = (e) => { onChange(e.currentTarget.innerHTML); }; const execCommand = (command) => { document.execCommand(command, false, null); editorRef.current.focus(); }; return ( <div className="relative border rounded focus-within:ring-2 ring-blue-200 bg-white h-full flex flex-col"> <div className="flex items-center gap-1 p-1 border-b bg-gray-50 rounded-t shrink-0"> <button onClick={() => execCommand('bold')} className="p-1 hover:bg-gray-200 rounded" title="KalÄ±n"> <Bold size={14} /> </button> <button onClick={() => execCommand('underline')} className="p-1 hover:bg-gray-200 rounded" title="AltÄ± Ã‡izili"> <Underline size={14} /> </button> <div className="flex-1"></div> {onPolish && value.length > 3 && ( <button onClick={() => onPolish(editorRef.current.innerText)} disabled={isPolishing} className="flex items-center gap-1 text-purple-600 bg-purple-100 hover:bg-purple-200 px-2 py-0.5 rounded text-xs font-bold transition disabled:opacity-50" > {isPolishing ? <Loader2 size={12} className="animate-spin" /> : <Wand2 size={12} />} DÃ¼zelt </button> )} </div> <div ref={editorRef} contentEditable onInput={handleInput} className="w-full text-sm p-2 outline-none overflow-y-auto flex-1" style={{ minHeight: minHeight }} /> {!value && ( <div className="absolute top-[42px] left-2 text-gray-400 text-sm pointer-events-none"> {placeholder} </div> )} </div> ); }; // --- HELPER COMPONENT: Smart List --- const SmartMedList = ({ title, items, onChange, colorClass = "text-gray-800", listId, namePlaceholder = "Ä°laÃ§ AdÄ±", dosePlaceholder = "Doz" }) => { const safeItems = Array.isArray(items) ? items : (items ? [{ id: Date.now(), name: items, dose: '' }] : []); const [newName, setNewName] = useState(''); const [newDose, setNewDose] = useState(''); const nameInputRef = useRef(null); const addItem = () => { if (!newName.trim()) return; onChange([...safeItems, { id: Date.now(), name: newName, dose: newDose }]); setNewName(''); setNewDose(''); if(nameInputRef.current) nameInputRef.current.focus(); }; return ( <div className="mb-4"> <label className={text-xs font-bold ${colorClass} uppercase tracking-wider block mb-1 border-b border-gray-200 pb-1}> {title} </label> <div className="space-y-1 mb-2"> {safeItems.map((item) => ( <div key={item.id} className="flex group items-start gap-2 text-sm"> <div className="flex-1 font-medium text-gray-800 break-words">{item.name}</div> <div className="w-1/3 text-gray-600 text-right">{item.dose}</div> <button onClick={() => onChange(safeItems.filter(i => i.id !== item.id))} className="opacity-0 group-hover:opacity-100 text-gray-400 hover:text-red-500 print:hidden px-1"><X size={14} /></button> </div> ))} </div> <div className="print:hidden bg-gray-50 p-2 rounded border border-gray-200 flex gap-2"> <input ref={nameInputRef} type="text" value={newName} onChange={(e) => setNewName(e.target.value)} placeholder={namePlaceholder} className="flex-1 bg-white border border-gray-300 rounded px-2 py-1 text-sm outline-none" onKeyDown={(e) => e.key === 'Enter' && document.getElementById(listId+'-dose')?.focus()} /> <input id={listId+'-dose'} type="text" value={newDose} onChange={(e) => setNewDose(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && addItem()} placeholder={dosePlaceholder} className="w-24 bg-white border border-gray-300 rounded px-2 py-1 text-sm outline-none" /> <button onClick={addItem} className="bg-blue-600 text-white px-2 rounded hover:bg-blue-700 text-xs"><Plus size={16} /></button> </div> </div> ); }; // --- COMPONENT: Consultation Manager --- const ConsultationManager = ({ consults, onChange }) => { const safeConsults = Array.isArray(consults) ? consults : (consults ? [{ id: Date.now(), date: 'Eski', specialty: 'Genel', note: consults, isArchived: false }] : []); const [spec, setSpec] = useState(''); const [note, setNote] = useState(''); const [showArchived, setShowArchived] = useState(false); const addConsult = () => { if (!note.trim()) return; const now = new Date(); const dateStr = ${String(now.getDate()).padStart(2, '0')}.${String(now.getMonth() + 1).padStart(2, '0')}; onChange([{ id: Date.now(), date: dateStr, specialty: spec.toUpperCase() || 'KONS', note, isArchived: false }, ...safeConsults]); setSpec(''); setNote(''); }; const active = safeConsults.filter(c => !c.isArchived); const archived = safeConsults.filter(c => c.isArchived); return ( <div className="mb-6"> <label className="text-xs font-bold text-gray-400 uppercase tracking-wider block mb-2 border-b pb-1">KonsÃ¼ltasyon & Ã–neriler</label> <div className="print:hidden bg-blue-50 p-2 rounded border border-blue-100 mb-4"> <div className="flex gap-2 mb-2"> <input type="text" value={spec} onChange={e => setSpec(e.target.value)} placeholder="BÃ¶lÃ¼m" className="flex-1 text-xs p-1 border rounded uppercase" /> <button onClick={addConsult} className="bg-blue-600 text-white text-xs px-2 rounded hover:bg-blue-700 font-bold"><Plus size={14} /> Ekle</button> </div> <textarea value={note} onChange={e => setNote(e.target.value)} placeholder="Not..." className="w-full text-xs p-1 border rounded resize-y h-16" /> </div> <div className="space-y-3"> {active.map(c => ( <div key={c.id} className="relative group bg-white border border-l-4 border-l-orange-400 p-2 rounded shadow-sm"> <div className="flex justify-between items-baseline mb-1"> <div className="flex gap-2 font-bold text-sm"><span className="text-gray-800">{c.date}</span><span className="text-orange-600">{c.specialty}</span></div> <div className="flex gap-1 print:hidden"> <button onClick={() => onChange(safeConsults.map(i => i.id === c.id ? {...i, isArchived: true} : i))} className="text-gray-400 hover:text-blue-500"><Archive size={14} /></button> <button onClick={() => onChange(safeConsults.filter(i => i.id !== c.id))} className="text-gray-400 hover:text-red-500"><Trash2 size={14} /></button> </div> </div> <div className="text-sm text-gray-700 whitespace-pre-wrap">{c.note}</div> </div> ))} </div> {archived.length > 0 && ( <div className="mt-4 print:hidden"> <button onClick={() => setShowArchived(!showArchived)} className="flex items-center gap-1 text-xs font-bold text-gray-500 w-full border-t pt-2">{showArchived ? <ChevronDown size={14}/> : <ChevronRight size={14}/>} GeÃ§miÅŸ ({archived.length})</button> {showArchived && <div className="mt-2 space-y-2 pl-2 border-l-2 border-gray-200">{archived.map(c => <div key={c.id} className="bg-gray-50 p-2 rounded text-xs text-gray-500"><b>{c.date} {c.specialty}</b>: {c.note} <button onClick={() => onChange(safeConsults.map(i => i.id === c.id ? {...i, isArchived: false} : i))} className="text-blue-500 ml-2"><History size={10}/></button></div>)}</div>} </div> )} </div> ); }; export default function App() { const [isAuthenticated, setIsAuthenticated] = useState(false); // Auth State const [passwordInput, setPasswordInput] = useState(''); const [authError, setAuthError] = useState(false); const [patients, setPatients] = useState([]); const [dashboardData, setDashboardData] = useState(initialDashboard); const [selectedId, setSelectedId] = useState(null); const [viewMode, setViewMode] = useState('detail'); const [newLogHTML, setNewLogHTML] = useState(''); const [isPolishing, setIsPolishing] = useState(false); const [isLoaded, setIsLoaded] = useState(false); // Modals & Status const [importModal, setImportModal] = useState({ show: false, patients: null, dashboard: null }); const [errorMessage, setErrorMessage] = useState(null); const [saveSuccess, setSaveSuccess] = useState(false); const fileInputRef = useRef(null); // --- AUTH CHECK --- useEffect(() => { const authDate = localStorage.getItem('handover_auth_date'); const today = new Date().toLocaleDateString(); if (authDate === today) { setIsAuthenticated(true); } }, []); const handleLogin = (e) => { e.preventDefault(); if (passwordInput === APP_PASSWORD) { setIsAuthenticated(true); localStorage.setItem('handover_auth_date', new Date().toLocaleDateString()); setAuthError(false); } else { setAuthError(true); } }; // --- INIT PDF & DATA --- useEffect(() => { if (!isAuthenticated) return; // Inject PDFMake const script1 = document.createElement('script'); script1.src = "https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"; script1.async = true; script1.onload = () => { const script2 = document.createElement('script'); script2.src = "https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"; script2.async = true; document.body.appendChild(script2); }; document.body.appendChild(script1); // Load Data - Migration Logic v4 -> v5 try { const savedV5 = localStorage.getItem('handoverData_v5'); const savedV4 = localStorage.getItem('handoverData_v4'); let dataToLoad = null; if (savedV5) { dataToLoad = JSON.parse(savedV5); } else if (savedV4) { dataToLoad = JSON.parse(savedV4); } if (dataToLoad) { if (dataToLoad.patients) { const sanitizedPatients = dataToLoad.patients.map(p => ({ ...initialPatient, ...p, medications: p.medications || [], logs: p.logs || [], consults: p.consults || [], antibiotics: p.antibiotics || [], narcotics: p.narcotics || [], medReports: p.medReports || [] })); setPatients(sanitizedPatients); setDashboardData(dataToLoad.dashboard || initialDashboard); if (sanitizedPatients.length > 0) setSelectedId(sanitizedPatients[0].id); } else if (Array.isArray(dataToLoad)) { setPatients(dataToLoad); if (dataToLoad.length > 0) setSelectedId(dataToLoad[0].id); } } else { const demoP = { ...initialPatient, id: Date.now().toString(), room: 'Oda 5', name: 'Nezir YÄ±lmaz', age: '76', gender: 'E', diagnosis: 'Parkinson, Demans', history: 'Trakeostomi 8.0\nPEG', logs: [{id: 1, date: '09.02.26', content: 'GD orta. Stabil.'}], status: 'critical', physicalExam: 'BatÄ±n rahat, defans yok.' }; setPatients([demoP]); setSelectedId(demoP.id); } } catch (e) { console.error("Load error", e); setErrorMessage("Veri yÃ¼klenirken hata oluÅŸtu."); } finally { setIsLoaded(true); } }, [isAuthenticated]); // Auto-Save - ONLY IF LOADED useEffect(() => { if (isLoaded && patients.length > 0) { const dataToSave = { patients, dashboard: dashboardData }; localStorage.setItem('handoverData_v5', JSON.stringify(dataToSave)); } }, [patients, dashboardData, isLoaded]); const activePatient = patients.find(p => p.id === selectedId) || initialPatient; // --- ACTIONS --- const handleAddPatient = () => { const newP = { ...initialPatient, id: Date.now().toString(), room: 'Yeni Oda', name: 'Yeni Hasta' }; setPatients([...patients, newP]); setSelectedId(newP.id); setViewMode('detail'); }; const updatePatient = (field, value) => { setPatients(patients.map(p => p.id === selectedId ? { ...p, [field]: value } : p)); }; const deletePatient = (id) => { if (confirm('Bu hastayÄ± silmek istediÄŸinize emin misiniz?')) { const newList = patients.filter(p => p.id !== id); setPatients(newList); setSelectedId(newList.length > 0 ? newList[0].id : null); } }; const handlePolishText = async (textToPolish) => { setIsPolishing(true); const polished = await polishNoteWithAI(textToPolish); setNewLogHTML(polished); setIsPolishing(false); }; const addLog = () => { if (!newLogHTML.trim()) return; const now = new Date(); const dateStr = ${String(now.getDate()).padStart(2, '0')}.${String(now.getMonth() + 1).padStart(2, '0')}.${String(now.getFullYear()).slice(-2)}; const newLog = { id: Date.now(), date: dateStr, content: newLogHTML }; updatePatient('logs', [newLog, ...(activePatient.logs || [])]); setNewLogHTML(''); }; const deleteLog = (logId) => { updatePatient('logs', activePatient.logs.filter(l => l.id !== logId)); }; // --- IMPORT/EXPORT --- const exportData = () => { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ patients, dashboard: dashboardData })); const a = document.createElement('a'); a.href = dataStr; a.download = "handover_backup_" + new Date().toISOString().slice(0,10) + ".json"; a.click(); }; const triggerImport = () => { if (fileInputRef.current) { fileInputRef.current.click(); } }; const handleImportFile = (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (event) => { try { const imported = JSON.parse(event.target.result); let newPatients = []; let newDashboard = initialDashboard; if (Array.isArray(imported)) { newPatients = imported; } else if (imported.patients) { newPatients = imported.patients; newDashboard = imported.dashboard || initialDashboard; } // Sanitize newPatients = newPatients.map(p => ({ ...initialPatient, ...p, medications: p.medications || [], logs: p.logs || [], consults: p.consults || [], antibiotics: p.antibiotics || [], narcotics: p.narcotics || [], medReports: p.medReports || [], physicalExam: p.physicalExam || '' // Ensure new field })); setImportModal({ show: true, patients: newPatients, dashboard: newDashboard }); } catch (err) { setErrorMessage("Dosya hatasÄ±."); setTimeout(() => setErrorMessage(null), 3000); } }; reader.readAsText(file); e.target.value = null; }; const confirmImport = () => { setPatients(importModal.patients); setDashboardData(importModal.dashboard); if(importModal.patients.length > 0) setSelectedId(importModal.patients[0].id); setImportModal({ show: false, patients: null, dashboard: null }); setIsLoaded(true); // Ensure saving works after import }; const handleManualSave = () => { localStorage.setItem('handoverData_v5', JSON.stringify({ patients, dashboard: dashboardData })); setSaveSuccess(true); setTimeout(() => setSaveSuccess(false), 2000); }; // --- PDF GENERATION --- const getDashboardPdfContent = () => { const criticalList = patients.filter(p => p.status === 'critical').map(p => â€¢ ${p.room} ${p.name} (${p.diagnosis})).join('\n'); const displayCriticalObs = dashboardData.criticalObs + (criticalList ? \n\n<b>KRÄ°TÄ°K HASTALAR:</b>\n${criticalList} : ""); return { table: { widths: ['25%', '25%', '25%', '25%'], body: [ [ { text: 'KAN TAKÄ°PLERÄ°', style: 'dashHeader', color: '#dc2626', fillColor: '#fee2e2' }, { text: 'KRÄ°TÄ°K GÃ–ZLEM', style: 'dashHeader', color: '#000000', fillColor: '#f3f4f6' }, { text: 'PLANLANAN', style: 'dashHeader', color: '#000000', fillColor: '#f3f4f6' }, { text: 'Kx TAKÄ°PLERÄ°', style: 'dashHeader', color: '#ea580c', fillColor: '#ffedd5' } ], [ { text: parseHtmlToPdfMake(dashboardData.bloodLabs).text, style: 'dashContent' }, { text: parseHtmlToPdfMake(displayCriticalObs).text, style: 'dashContent' }, { text: parseHtmlToPdfMake(dashboardData.plans).text, style: 'dashContent' }, { text: parseHtmlToPdfMake(dashboardData.cultures).text, style: 'dashContent' } ] ] }, layout: { hLineWidth: () => 1, vLineWidth: () => 1, hLineColor: '#000', vLineColor: '#000' }, pageBreak: 'after' }; }; const getPatientPdfContent = (patient) => { // Column 1 const col1 = [ { text: patient.name, style: 'header', color: '#dc2626' }, { text: ${patient.age} / ${patient.gender}, style: 'subheader' }, { text: patient.diagnosis, margin: [0, 4, 0, 8], fontSize: 8 }, { text: 'Ã–ykÃ¼ / Cihazlar:', style: 'label' }, { text: patient.history || '-', fontSize: 8, margin: [0, 0, 0, 8] }, { text: 'Ä°laÃ§lar / BES:', style: 'label' } ]; patient.medications.forEach(m => col1.push({ columns: [{ text: m.name, width: '*', fontSize: 8 }, { text: m.dose, width: 'auto', fontSize: 8, bold: true }], margin: [0, 1] })); // Column 2 const col2 = []; if (patient.physicalExam) { col2.push({ text: 'GÃœNCEL FÄ°ZÄ°K MUAYENE', style: 'label', color: '#059669', decoration: 'underline' }); col2.push({ text: parseHtmlToPdfMake(patient.physicalExam).text, fontSize: 8, margin: [0, 0, 0, 10] }); col2.push({ text: ' ', margin: [0, 2] }); // Spacer } patient.logs.forEach(log => { col2.push({ text: log.date, style: 'logDate' }); col2.push({ text: parseHtmlToPdfMake(log.content).text, fontSize: 8, margin: [0, 0, 0, 8] }); }); // Column 3 const col3 = []; const activeConsults = patient.consults.filter(c => !c.isArchived); if (activeConsults.length > 0) { col3.push({ text: 'KonsÃ¼ltasyonlar:', style: 'label' }); activeConsults.forEach(c => col3.push({ text: [{ text: ${c.date} ${c.specialty}: , bold: true, color: '#ea580c' }, { text: c.note, fontSize: 8 }], margin: [0, 0, 0, 4] })); col3.push({ text: ' ', margin: [0, 4] }); } if (patient.antibiotics.length > 0) { col3.push({ text: 'Antibiyotik:', style: 'label', color: '#dc2626' }); patient.antibiotics.forEach(m => col3.push({ columns: [{ text: m.name, width: '*', fontSize: 8 }, { text: m.dose, width: 'auto', fontSize: 8, bold: true }], margin: [0, 1] })); col3.push({ text: ' ', margin: [0, 4] }); } if (patient.narcotics.length > 0) { col3.push({ text: 'Narkotik:', style: 'label', color: '#7c3aed' }); patient.narcotics.forEach(m => col3.push({ columns: [{ text: m.name, width: '*', fontSize: 8 }, { text: m.dose, width: 'auto', fontSize: 8, bold: true }], margin: [0, 1] })); col3.push({ text: ' ', margin: [0, 4] }); } if (patient.plan) { col3.push({ text: 'Planlanan:', style: 'label' }); col3.push({ text: patient.plan, fontSize: 8, bold: true, color: '#b91c1c' }); col3.push({ text: ' ', margin: [0, 4] }); } if (patient.medReports.length > 0) { col3.push({ text: 'Ä°laÃ§ RaporlarÄ±:', style: 'label', color: '#2563eb' }); patient.medReports.forEach(m => col3.push({ columns: [{ text: m.name, width: '*', fontSize: 8 }, { text: m.dose, width: 'auto', fontSize: 8, bold: true }], margin: [0, 1] })); } return [{ table: { widths: ['33%', '34%', '33%'], headerRows: 1, body: [ [ { text: patient.room, style: 'topHeader', border: [false, false, true, true] }, { text: 'GÃœNLÃœK GÃ–ZLEM', style: 'topHeader', alignment: 'center', border: [false, false, true, true] }, { text: 'KONS & PLAN', style: 'topHeader', border: [false, false, false, true] } ], [ { stack: col1, margin: [0, 8, 8, 0], border: [false, false, true, false] }, { stack: col2, margin: [8, 8, 8, 0], border: [false, false, true, false] }, { stack: col3, margin: [8, 8, 0, 0], border: [false, false, false, false] } ] ] }, layout: { hLineWidth: (i) => (i === 1 ? 1 : 0), vLineWidth: (i, node) => (i > 0 && i < node.table.widths.length ? 1 : 0), hLineColor: '#000', vLineColor: '#000' }, pageBreak: 'after' }]; }; const downloadAllPatientsPDF = () => { if (!window.pdfMake) { alert("PDF motoru yÃ¼kleniyor..."); return; } const dashboardContent = getDashboardPdfContent(); const patientContent = []; patients.forEach((p, index) => { const pContent = getPatientPdfContent(p); if (index === patients.length - 1) pContent[0].pageBreak = undefined; patientContent.push(pContent); }); const docDefinition = { pageSize: 'A4', pageOrientation: 'landscape', pageMargins: [15, 15, 15, 15], content: [dashboardContent, ...patientContent], styles: { dashHeader: { fontSize: 10, bold: true, margin: [0, 5], alignment: 'center' }, dashContent: { fontSize: 9, margin: [0, 5] }, topHeader: { fontSize: 11, bold: true, margin: [0, 4] }, header: { fontSize: 13, bold: true }, subheader: { fontSize: 9, bold: true, margin: [0, 1] }, label: { fontSize: 8, bold: true, decoration: 'underline', margin: [0, 2, 0, 2] }, logDate: { fontSize: 8, bold: true } } }; window.pdfMake.createPdf(docDefinition).download(Handover_Tumu_${new Date().toLocaleDateString()}.pdf); }; const downloadPDF = () => { if (!window.pdfMake) { alert("PDF motoru yÃ¼kleniyor..."); return; } const content = getPatientPdfContent(activePatient); content[0].pageBreak = undefined; const docDefinition = { pageSize: 'A4', pageOrientation: 'landscape', pageMargins: [15, 15, 15, 15], content: content, styles: { topHeader: { fontSize: 11, bold: true, margin: [0, 4] }, header: { fontSize: 13, bold: true }, subheader: { fontSize: 9, bold: true, margin: [0, 1] }, label: { fontSize: 8, bold: true, decoration: 'underline', margin: [0, 2, 0, 2] }, logDate: { fontSize: 8, bold: true } } }; window.pdfMake.createPdf(docDefinition).download(Handover_${activePatient.room}.pdf); }; // --- LOGIN SCREEN --- if (!isAuthenticated) { return ( <div className="min-h-screen flex items-center justify-center bg-gray-100 font-sans p-4"> <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm text-center border border-gray-200"> <div className="bg-blue-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner"> <Lock className="text-blue-600" size={40} /> </div> <h2 className="text-2xl font-bold mb-2 text-gray-800">Palyatif Handover</h2> <p className="text-gray-500 text-sm mb-8">GÃ¼venli giriÅŸ iÃ§in ÅŸifrenizi giriniz.</p> <form onSubmit={handleLogin}> <input type="password" value={passwordInput} onChange={(e) => setPasswordInput(e.target.value)} placeholder="Åžifre" className="w-full border border-gray-300 p-3 rounded-lg mb-4 outline-none focus:ring-2 ring-blue-400 focus:border-blue-400 text-center tracking-widest text-lg transition-all" autoFocus /> {authError && <div className="text-red-500 text-sm mb-4 font-bold flex items-center justify-center gap-1"><AlertCircle size={16}/> HatalÄ± Åžifre!</div>} <button type="submit" className="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 rounded-lg hover:from-blue-700 hover:to-indigo-700 transition font-bold shadow-md transform active:scale-95" > GiriÅŸ Yap </button> </form> <div className="mt-6 text-xs text-gray-400"> &copy; 2026 Palyatif Servisi </div> </div> </div> ); } // --- MAIN APP --- return ( <div className="min-h-screen bg-gray-100 font-sans text-gray-800 flex flex-col h-screen"> <input type="file" ref={fileInputRef} onChange={handleImportFile} style={{ display: 'none' }} accept=".json" /> {/* ALERTS */} {errorMessage && <div className="fixed top-4 right-4 bg-red-600 text-white px-4 py-3 rounded shadow-lg z-50 animate-bounce">{errorMessage}</div>} {saveSuccess && <div className="fixed top-4 right-4 bg-green-600 text-white px-4 py-3 rounded shadow-lg z-50 animate-fade-in-out">BaÅŸarÄ±yla Kaydedildi</div>} {/* IMPORT MODAL */} {importModal.show && ( <div className="fixed inset-0 bg-black/50 flex justify-center items-center z-50"> <div className="bg-white p-6 rounded-lg shadow-xl max-w-md w-full"> <h3 className="text-lg font-bold mb-2 flex items-center gap-2">Veri YÃ¼kleme OnayÄ±</h3> <p className="text-sm mb-4">Mevcut veriler silinecek ve <strong>{importModal.patients?.length}</strong> hasta yÃ¼klenecektir.</p> <div className="flex justify-end gap-2"> <button onClick={() => setImportModal({show:false})} className="px-3 py-1 bg-gray-200 rounded">Ä°ptal</button> <button onClick={confirmImport} className="px-3 py-1 bg-blue-600 text-white rounded">YÃ¼kle</button> </div> </div> </div> )} {/* HEADER */} <div className="bg-slate-800 text-white p-3 shadow-md flex justify-between items-center shrink-0"> <div className="flex items-center gap-2"> <Activity className="h-6 w-6 text-red-400" /> <h1 className="text-lg font-bold hidden sm:block">Palyatif Handover</h1> </div> <div className="flex gap-2"> <button onClick={downloadAllPatientsPDF} className="flex items-center gap-1 text-xs bg-indigo-600 hover:bg-indigo-500 px-3 py-1.5 rounded font-bold shadow transition"><Files size={14} /> TÃ¼mÃ¼nÃ¼ Ä°ndir</button> <button onClick={downloadPDF} className="flex items-center gap-1 text-xs bg-blue-600 hover:bg-blue-500 px-3 py-1.5 rounded font-bold shadow transition"><FileDown size={14} /> PDF</button> <button onClick={triggerImport} className="flex items-center gap-1 text-xs bg-green-600 hover:bg-green-500 px-3 py-1.5 rounded font-bold shadow transition"><Upload size={14} /> YÃ¼kle</button> <button onClick={handleManualSave} className="flex items-center gap-1 text-xs bg-emerald-600 hover:bg-emerald-500 px-3 py-1.5 rounded font-bold shadow transition"><Save size={14} /> Kaydet</button> <button onClick={exportData} className="flex items-center gap-1 text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded text-gray-300 font-bold" title="Yedek Al"><FileJson size={14} /></button> </div> </div> <div className="flex flex-1 overflow-hidden"> {/* SIDEBAR */} <div className="w-14 hover:w-64 transition-all duration-300 bg-white border-r flex flex-col shadow-lg z-10 group shrink-0"> <div className="p-2 border-b space-y-1"> <button onClick={() => setViewMode('dashboard')} className={w-full flex items-center gap-3 p-2 rounded transition whitespace-nowrap ${viewMode === 'dashboard' ? 'bg-indigo-50 text-indigo-700' : 'text-gray-600 hover:bg-gray-100'}}> <div className="min-w-[1.5rem] flex justify-center"><LayoutDashboard size={20} /></div> <span className="opacity-0 group-hover:opacity-100 transition-opacity font-bold text-sm">Genel BakÄ±ÅŸ</span> </button> <button onClick={handleAddPatient} className="w-full flex items-center gap-3 p-2 rounded transition whitespace-nowrap text-green-700 hover:bg-green-50"> <div className="min-w-[1.5rem] flex justify-center"><UserPlus size={20} /></div> <span className="opacity-0 group-hover:opacity-100 transition-opacity font-bold text-sm">Yeni Hasta</span> </button> </div> <div className="flex-1 overflow-y-auto"> {patients.map(p => ( <div key={p.id} onClick={() => { setSelectedId(p.id); setViewMode('detail'); }} className={p-2 border-b cursor-pointer hover:bg-gray-50 flex items-center gap-3 whitespace-nowrap overflow-hidden ${selectedId === p.id && viewMode === 'detail' ? 'bg-blue-50 border-l-4 border-l-blue-500' : ''}}> <div className="min-w-[1.5rem] text-center font-bold text-gray-700 text-sm relative"> {p.room.replace(/[^0-9]/g, '') || <User size={18} />} {p.status === 'critical' && <span className="absolute -top-1 -right-1 w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>} </div> <div className="opacity-0 group-hover:opacity-100 transition-opacity duration-200"> <div className="font-bold text-gray-800 text-xs flex items-center gap-2">{p.room} {p.status === 'critical' && <AlertCircle size={12} className="text-red-500"/>}</div> <div className="text-xs text-gray-500 truncate w-32">{p.name || 'Ä°simsiz'}</div> </div> </div> ))} </div> </div> {/* MAIN VIEW */} <div className="flex-1 overflow-y-auto bg-gray-50 p-4"> {/* DASHBOARD VIEW */} {viewMode === 'dashboard' ? ( <div className="h-full flex flex-col"> <h2 className="text-xl font-bold mb-4 flex items-center gap-2"><LayoutDashboard className="text-indigo-600"/> Genel Durum & Devir Ã–zeti</h2> <div className="flex-1 grid grid-cols-4 gap-4 min-h-0"> {/* COL 1: KAN TAKÄ°PLERÄ° */} <div className="flex flex-col border rounded bg-white shadow-sm h-full"> <div className="p-2 bg-red-100 text-red-800 font-bold text-center border-b uppercase text-sm">Kan Takipleri</div> <div className="flex-1 p-0 overflow-hidden"> <RichTextEditor value={dashboardData.bloodLabs} onChange={(val) => setDashboardData({...dashboardData, bloodLabs: val})} placeholder="Kan, Biyokimya..." /> </div> </div> {/* COL 2: KRÄ°TÄ°K */} <div className="flex flex-col border rounded bg-white shadow-sm h-full"> <div className="p-2 bg-gray-800 text-white font-bold text-center border-b uppercase text-sm">Kritik GÃ¶zlem</div> <div className="bg-red-50 p-2 border-b text-xs max-h-32 overflow-y-auto"> <div className="font-bold text-red-700 mb-1">KRÄ°TÄ°K HASTALAR:</div> {patients.filter(p => p.status === 'critical').map(p => ( <div key={p.id} className="flex justify-between items-center mb-1"> <span>â€¢ {p.room} {p.name}</span> <button onClick={() => { setSelectedId(p.id); setViewMode('detail'); }} className="text-blue-500 hover:underline">Git</button> </div> ))} {patients.filter(p => p.status === 'critical').length === 0 && <span className="text-gray-400 italic">Yok</span>} </div> <div className="flex-1 p-0 overflow-hidden"> <RichTextEditor value={dashboardData.criticalObs} onChange={(val) => setDashboardData({...dashboardData, criticalObs: val})} placeholder="Genel kritik notlar..." /> </div> </div> {/* COL 3: PLAN */} <div className="flex flex-col border rounded bg-white shadow-sm h-full"> <div className="p-2 bg-gray-800 text-white font-bold text-center border-b uppercase text-sm">Planlanan</div> <div className="flex-1 p-0 overflow-hidden"> <RichTextEditor value={dashboardData.plans} onChange={(val) => setDashboardData({...dashboardData, plans: val})} placeholder="Genel planlar..." /> </div> </div> {/* COL 4: KÃœLTÃœR */} <div className="flex flex-col border rounded bg-white shadow-sm h-full"> <div className="p-2 bg-orange-100 text-orange-800 font-bold text-center border-b uppercase text-sm">Kx Takipleri</div> <div className="flex-1 p-0 overflow-hidden"> <RichTextEditor value={dashboardData.cultures} onChange={(val) => setDashboardData({...dashboardData, cultures: val})} placeholder="KÃ¼ltÃ¼r sonuÃ§larÄ±..." /> </div> </div> </div> </div> ) : ( // DETAIL VIEW (PATIENT) <div className="bg-white shadow-sm border rounded-lg min-h-[800px] flex flex-col lg:flex-row h-full overflow-hidden"> {/* COL 1: INFO */} <div className="w-full lg:w-1/4 p-4 border-r border-gray-200 overflow-y-auto"> <div className="mb-4"> <div className="flex justify-between items-center mb-2"> <label className="text-xs font-bold text-gray-400 uppercase">Hasta Bilgileri</label> <select value={activePatient.status} onChange={(e) => updatePatient('status', e.target.value)} className={text-xs font-bold border rounded px-1 py-0.5 ${activePatient.status === 'critical' ? 'bg-red-100 text-red-600 border-red-300' : activePatient.status === 'discharge' ? 'bg-yellow-100 text-yellow-600' : 'bg-green-100 text-green-600'}} > <option value="stable">ðŸŸ¢ Stabil</option> <option value="critical">ðŸ”´ Kritik</option> <option value="discharge">ðŸŸ¡ Taburcu</option> </select> </div> <input type="text" value={activePatient.room} onChange={(e) => updatePatient('room', e.target.value)} placeholder="Oda No" className="w-full font-bold text-lg border-b mb-1 outline-none"/> <div className="flex gap-2 mb-2"> <input type="text" value={activePatient.name} onChange={(e) => updatePatient('name', e.target.value)} placeholder="Ad Soyad" className="flex-1 font-medium text-red-600 border-b outline-none"/> <input type="text" value={activePatient.age} onChange={(e) => updatePatient('age', e.target.value)} placeholder="YaÅŸ" className="w-12 text-sm border-b outline-none"/> <input type="text" value={activePatient.gender} onChange={(e) => updatePatient('gender', e.target.value)} placeholder="C" className="w-8 text-sm border-b outline-none"/> </div> <textarea value={activePatient.diagnosis} onChange={(e) => updatePatient('diagnosis', e.target.value)} placeholder="TANI: ..." className="w-full text-sm font-bold min-h-[60px] border-none outline-none resize-y bg-gray-50 p-1 rounded"/> </div> <div className="mb-6"> <h3 className="font-bold text-sm border-b pb-1 mb-2">Ã–ykÃ¼ / Cihazlar</h3> <textarea value={activePatient.history} onChange={(e) => updatePatient('history', e.target.value)} className="w-full text-sm min-h-[100px] border-none outline-none resize-y bg-gray-50 p-1 rounded" placeholder="PEG, Trakeostomi vb..."/> </div> <SmartMedList title="Ä°laÃ§lar / BES" items={activePatient.medications} onChange={(n) => updatePatient('medications', n)} listId="meds" /> <div className="mt-10"><button onClick={() => deletePatient(activePatient.id)} className="text-red-400 text-xs flex items-center gap-1 hover:text-red-600"><Trash2 size={12} /> HastayÄ± Sil</button></div> </div> {/* COL 2: LOGS & PHYSICAL EXAM */} <div className="w-full lg:w-2/4 p-4 border-r border-gray-200 bg-gray-50 overflow-y-auto"> {/* NEW: PHYSICAL EXAM SECTION */} <label className="text-xs font-bold text-green-700 uppercase tracking-wider block mb-2 flex items-center gap-1"><Stethoscope size={14}/> GÃ¼ncel Fizik Muayene</label> <div className="mb-6 h-32 border border-green-200 rounded shadow-sm resize-y overflow-hidden"> <RichTextEditor value={activePatient.physicalExam} onChange={(val) => updatePatient('physicalExam', val)} placeholder="BatÄ±n rahat, defans yok..." minHeight="80px" /> </div> <label className="text-xs font-bold text-gray-400 uppercase tracking-wider block mb-2">GÃ¼nlÃ¼k GÃ¶zlem</label> <div className="mb-6 h-48 resize-y overflow-hidden"> <RichTextEditor value={newLogHTML} onChange={setNewLogHTML} placeholder="HÄ±zlÄ± not: gd orta..." onPolish={handlePolishText} isPolishing={isPolishing} minHeight="120px" /> <button onClick={addLog} className="w-full bg-blue-600 text-white text-sm py-2 mt-2 rounded hover:bg-blue-700 font-medium">Ekle (Tarihli)</button> </div> <div className="space-y-4"> {activePatient.logs.map((log) => ( <div key={log.id} className="relative group bg-white p-2 rounded shadow-sm border"> <div className="font-bold text-sm text-gray-800 mb-1 border-b pb-1">{log.date}</div> <div className="text-sm" dangerouslySetInnerHTML={{ __html: log.content }} /> <button onClick={() => deleteLog(log.id)} className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 text-gray-400 hover:text-red-500"><Trash2 size={14} /></button> </div> ))} </div> </div> {/* COL 3: PLANS */} <div className="w-full lg:w-1/4 p-4 overflow-y-auto"> <ConsultationManager consults={activePatient.consults} onChange={(n) => updatePatient('consults', n)} /> <SmartMedList title="Antibiyotik" items={activePatient.antibiotics} onChange={(n) => updatePatient('antibiotics', n)} colorClass="text-red-600" listId="abx" /> <SmartMedList title="Narkotik" items={activePatient.narcotics} onChange={(n) => updatePatient('narcotics', n)} colorClass="text-purple-600" listId="narc" /> <div className="mb-6"> <label className="text-xs font-bold text-gray-900 uppercase tracking-wider block mb-1">Planlanan</label> <textarea value={activePatient.plan} onChange={(e) => updatePatient('plan', e.target.value)} className="w-full text-sm font-bold text-red-700 min-h-[100px] border rounded p-2 focus:ring-1 ring-blue-300 outline-none resize-y" placeholder="Plan..." /> </div> <SmartMedList title="Ä°laÃ§ Rapor NumarasÄ±" items={activePatient.medReports} onChange={(n) => updatePatient('medReports', n)} colorClass="text-blue-600" listId="rep" namePlaceholder="Ä°laÃ§" dosePlaceholder="Rapor No" /> </div> </div> )} </div> </div> </div> ); }
